<!doctype html>
<html>
  <head>
    <title>UNIVAX - One Editor To Rule Them All</title>
    <style>
      body {
        position: absolute;
        margin: 0; left: 0; right: 0; top: 0; bottom: 0;
        white-space: pre;
        font-family: monospace;
        font-size: 150%;
        line-height: 250%;
      }
    </style>
  </head>
  <body>
    <p>helloooo</p>
  </body>
</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  $(function (event) {
    var socket = io();

    // Of course, implementing a text editor from scratch in a few lines of
    // code is a joke. Missing features include: moving the cursor by clicking
    // the mouse; the selection (which should be supported both mouse and
    // keyboard); copy and paste; shift/alt/ctrl in combination with movement
    // keys; remembering what column we should be in when moving up or down
    // across a blank line; any code editing features at all, like automatic
    // indentation or code highlighting...

    // Forward all input to the server.
    function type(ch) { socket.emit('type', ch); }
    function move(dir) { socket.emit('move', dir); }
    function del(dir) { socket.emit('delete', dir); }

    var body = $(document.body);

    body.keypress(function (event) {
      var ch = String.fromCharCode(event.keyCode || event.charCode);
      if (event.ctrlKey || event.altKey || event.metaKey)
        return;
      type(ch);
      event.preventDefault();
    });

    body.keydown(function (event) {
      if (event.ctrlKey || event.altKey || event.metaKey)
        return;
      switch (event.keyCode) {
        case  8: del("left");   break;
        case 13: type("\n");    break;
        case 36: move("home");  break;
        case 35: move("end");   break;
        case 37: move("left");  break;
        case 38: move("up");    break;
        case 39: move("right"); break;
        case 40: move("down");  break;
        case 46: del("right");  break;
        default:
          return;
      }
      event.preventDefault();
    });

    // Update the DOM when the server tells us to.
    var me;
    var text;
    var cursors;

    function render() {
      body.empty();

      var cursorsByOffset = [];
      for (var id in cursors)
        cursorsByOffset.push({id: Number(id), offset: cursors[id]});
      cursorsByOffset.sort(function (a, b) { return a.offset - b.offset; });

      var charsWritten = 0;
      for (var i = 0; i < cursorsByOffset.length; i++) {
        var cursor = cursorsByOffset[i];
        if (cursor.offset > charsWritten) {
          body.append(text.slice(charsWritten, cursor.offset));
          charsWritten = cursor.offset;
        }
        var span = document.createElement("span");
        span.className = "cursor";
        span = $(span);
        span.css({width: "-4px", border: "1px solid red"});
        body.append(span);
      }
      body.append(text.slice(charsWritten, text.length));
    }

    socket.on("welcome", function (event) {
      me = event.id;
      text = event.document;
      cursors = event.cursors;
      render();
    });

    socket.on("typed", function (event) {
      text = text.slice(0, event.offset) + event.ch + text.slice(event.offset, text.length);
      for (var id in cursors) {
        id = Number(id);
        if (cursors[id] > event.offset || id === event.user)
          cursors[id]++;
      }
      render();
    });

    socket.on("moved", function (event) {
      cursors[event.user] = event.offset;
      render();
    });

    socket.on("deleted", function (event) {
      var start = event.start,
          stop = event.stop,
          len = stop - start;

      text = text.slice(0, start) + text.slice(stop, text.length);
      for (var id in cursors) {
        id = Number(id);
        var pos = cursors[id];
        if (pos > start)
          cursors[id] = (pos > stop ? pos - len : start);
      }
      render();
    });

    socket.on("connected", function (id) {
      cursors[id] = 0;
      render();
    });

    socket.on("disconnected", function (id) {
      delete cursors[id];
      render();
    });

    body.text("");
    body.focus();
  });
</script>
